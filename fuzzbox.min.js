/*!
 * 
 * fuzzbox.js
 *
 * Flexible media lightbox for jQuery
 *
 * Homepage: https://github.com/peteboere/fuzzbox
 * License: http://www.opensource.org/licenses/mit-license.php
 * Copyright: (c) 2012 Pete Boere
 *
 */
(function(y){var B=window,d=document,w=y(B),L=y(d),k=y.extend,F=y.each,e=function(M){if(!s.DEBUG){return}B.console.log("fuzzbox: "+M)},C=function(M){return typeof M!=="undefined"},v=function(M){return M.charAt(0).toUpperCase()+M.substring(1)},o=function(R){var M=o;M.c=M.c||{};if(R in M.c){return M.c[R]}var O=d.documentElement.style;if(R in O){M.c[R]=R;return R}else{var Q="Webkit Moz O ms Khtml".split(" "),P=v(R),N=0,S;for(;N<Q.length;N++){S=Q[N]+P;if(S in O){M.c[R]=S;return S}}}M.c[R]=null;return null},i=o("transition"),p={transition:"transitionend",WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",msTransition:"MSTransitionEnd"},K=i&&p[i],H=function(S,P,O,Q,R,M){var M=M||function(){};if(i){S.each(function(){var V=this,T=y(this),U=function(){V.removeEventListener(K,U,false);V.style[i]="";M()};if(T.css(P)!=O){V.style[i]=["all",R,Q+"ms"].join(" ");V.addEventListener(K,U,false);V.style[P]=O}else{M()}})}else{var N={};N[P]=O;S.animate(N,Q,R,M)}},G=function(P,N,O,M){H(P,"opacity",N,O,"linear",M)},m=function(Q,N,P){var M=Q;if(N.indexOf("*")===-1){M.removeClass(N);return !P?M:M.addClass(P)}var O=new RegExp("\\s"+N.replace(/\*/g,"[A-Za-z0-9-_]+").split(" ").join("\\s|\\s")+"\\s","g");M.each(function(R,S){var T=" "+S.className+" ";while(O.test(T)){T=T.replace(O," ")}S.className=y.trim(T)});return !P?M:M.addClass(P)},c=function(N,M){return setTimeout(N,M||0)},x=function(M){return d.createElement(M)},b=function(){};B.console=B.console||{log:b,error:b};Object.keys=Object.keys||function(O){var N=[],M;for(M in O){if(O.hasOwnProperty(M)){N.push(M)}}return N};var s=y.fuzzbox=function(M){var M=this.options=k({vAlign:"middle",transitionFadeSpeed:100,theme:"default",template:"basic",text:J.text,cycle:false,exactFit:false,closeOnClickOutside:true,closeOnPressEscape:true},M||{})};s.prototype={options:{},items:[],previousItem:null,activeItem:null,index:null,dims:null,trigger:null,$template:null,open:function(Y){var aa=this;aa.options=r=k(aa.options,Y||{});s.init();aa.$template=s.template[r.template||"basic"];var Z=n.$inner;Z.append(aa.$template);n.$content=Z.find("#fzz-content");n.$caption=Z.find("#fzz-caption");n.$previous=Z.find("#fzz-previous");n.$next=Z.find("#fzz-next");n.$closeBtn.find(">span").html(r.text.close);n.$previous.find(">span").html(r.text.previous);n.$next.find(">span").html(r.text.next);var V=r.items||[],R="html" in r;if(R||r.url){var T={caption:r.caption,mediaArgs:r.mediaArgs,element:r.element,width:r.width,height:r.height};if(R){T.html=r.html}else{T.url=r.url}V=[T]}V=y.grep(V,function(af,ab){var ac=("html" in af)||(af.url&&af.url!=location.href);if(!ac){return false}var ae=af.element,ad=z(ae),ag;if("html" in af){ag="html"}else{if(af.media){ag=af.media}else{if(ad&&ad.media){ag=ad.media}else{if(!(ag=j(af.url))){ag="html"}}}}af.media=new u(ag);af.attr=ad||{};if("html"===af.media[0]&&!C(af.html)&&af.attr.html){af.html=unescape(af.attr.html)}if(ad){if(ad.mediaArgs){af.mediaArgs=k({},ad.mediaArgs,af.mediaArgs)}}return !!ag});var M=V.length,U=M===1;if(!M){e("No items to display");return false}F(V,function(ab,ac){ac.index=ab;ac.group=V});aa.items=V;aa.index=r.index||0;if(aa.index>M-1){aa.index=M-1}l=aa.items[aa.index];D=s.instance=this;var S=(U&&l.attr.theme)||r.theme||"default",Q=["fzz-startup","fzz-itemcount-"+aa.items.length,"fzz-theme-"+y.trim(S).split(" ").join(" fzz-theme-")];n.$fuzzbox.attr("class",Q.join(" "));var N="width" in r?r.width:"",X="height" in r?r.height:"",U=M===1,P=l.attr.width,O=l.attr.height,W=/[^0-9\.]/;if(!N&&U&&P){N=W.test(P)?P:+P}if(!X&&U&&l.attr.height){X=W.test(O)?O:+O}aa.dims={width:N,height:X};s.setDims();A();s._open();q("open");aa.trigger=d.activeElement;n.$wrapper.focus();a=true;aa.loadItem(l,function(){m(n.$fuzzbox,"fzz-startup","fzz-open");a=false});return true},loadItem:function(U,S){var V=this,M=n.$content[0],O=n.$caption[0];V.previousItem=f=V.activeItem;V.activeItem=l=U;V.prepareLoadMsg();var Q=null,P;if("errorMsg" in U){Q="error"}else{var W=U.media.toString(),N=U.media[0];if(s.media[W]){Q=W}else{if(s.media[N]){Q=N}else{Q="html"}}}var T=s.media[Q],R=function(aa,Y){V.clearContentAreas();m(n.$fuzzbox,"fzz-media-*",E(aa.media).join(" "));T.insert(aa,M,aa.mediaArgs||r.mediaArgs||{});var X=aa.caption||V.options.caption,Z=aa.element;if("function"===typeof X){X=X.call(Z||{},aa)}O.innerHTML=X||(Z&&Z.title)||"";q("insert");S&&S();s.positionHero();s.position()};if(!T.load){V.cancelLoadMsg();q("load");I(function(){R(U,Q)})}else{T.load(U,function(){V.cancelLoadMsg();q("load");if(U.errorMsg){Q="error";T=s.media[Q];U.media.update(Q)}I(function(){R(U,Q)})})}},prepareLoadMsg:function(){var M=this;M.loadTimer=setTimeout(function(){M.showLoadMsg()},J.preloadDelay)},cancelLoadMsg:function(){var M=this;M.hideLoadMsg();clearTimeout(M.loadTimer)},showLoadMsg:function(){t=true;n.$loading.show();n.$fuzzbox.addClass("fzz-loading");q("showLoadMsg")},hideLoadMsg:function(){t=false;n.$loading.hide();n.$fuzzbox.removeClass("fzz-loading");q("hideLoadMsg")},disableElement:function(M){M.addClass("disabled").attr("tabindex",-1).blur()},enableElement:function(M){M.removeClass("disabled").removeAttr("tabindex")},goTo:function(P){var O=this,N=O.items,S=N.length-1,M=O.index;if(t||N.length<2){return}var R=r.cycle,Q;if("previous"==P){Q=(M>0)?M-1:0;if(R){Q=M===0?S:M-1}}else{if("next"==P){Q=(M<S)?M+1:S;if(R){Q=M===S?0:M+1}}else{if(P>0){P-=1;Q=P<=S?P:S}else{e("No destination");return}}}O.index=Q;A(O);O.loadItem(N[O.index])},next:function(){var M=this;if(!r.cycle&&M.index>=M.items.length-1){return}this.goTo("next")},previous:function(){var M=this;if(!r.cycle&&M.index<=0){return}M.goTo("previous")},close:function(){var M=this;s._close(function(){q("close");if(l.element){l.element.focus()}else{M.trigger&&M.trigger.focus()}M.cleanup()})},cleanup:function(){var M=this;M.clearContentAreas(true);M.enableElement(n.$previous);M.enableElement(n.$next);M.cancelLoadMsg();n.$fuzzbox.removeClass("fzz-open");var N=n.$wrapper[0].style;N.top=N.left="";s.instance=D=null},clearContentAreas:function(N){var M=f&&!f.errorMsg&&"image"===f.media[0]&&"image"===l.media[0];if(!M){n.$content.empty()}n.$caption.empty();s.getIframe(false);var O=s.getImage();O.src=O.style.marginTop="";n.$content.find(".fzz-hero").css("margin-top","");if(N){n.$inner.empty()}}};var D,l,f,a,r,t,u=function(N){var M=this;M.update=function(P){if(typeof P!=="string"){return P}var O=P.indexOf("/");M[0]=P;M[1]=null;if(O!==-1){M[0]=P.substring(0,O);M[1]=P.substring(O+1)}};M.toString=function(){return M[0]+(M[1]?"/"+M[1]:"")};return M.update(N)},j=function(P){var N=P.toLowerCase(),S=N.indexOf("#"),R=null;if(S!==-1){N=N.substring(0,S)}S=N.indexOf("?");if(S!==-1){N=N.substring(0,S)}var O,M=/\.([a-z0-9]+)$/.exec(N.replace(/\/+$/,"").toLowerCase());if(M){O=M[1]}else{return R}if(M=/^(jpe?g|png|gif|tiff?|webp)$/.exec(O)){R="image/"+M[1]}else{if(/^svgz?$/.test(O)){R="image/svg+xml"}else{if(/^(webm|ogv|ogg|ogv|mp4|m4v|3gp)?$/.test(O)){var Q="mp4";if(/^(ogv|ogg|ogm)$/.test(O)){Q="ogg"}else{if("webm"===O){Q="webm"}}R="video/"+Q}else{if(M=/^(mp3)?$/.exec(O)){R="audio/"+M[1]}else{if(/^html?$/.test(O)){R="html"}}}}}return R},z=function(N){if(!N){return null}var M={},O="data-fzz-";F(N.attributes,function(S,P){var R=P.name,V=R.indexOf(O);if(0===V){R=R.substring(O.length);var T=R.split("-"),U=T.shift();if(!M[U]&&!T.length){M[U]=P.value}else{if(T.length){var Q=U+"Args";M[Q]=M[Q]||{};M[Q][T[0]]=P.value}}}});return M},E=function(M){var N=[];N.push("fzz-media-"+M[0]);N.push("fzz-media-"+(M+"").replace(/\//,"-"));return N},q=function(M){var N="on"+v(M);L.trigger("fzz_"+M);D&&D[N]&&D[N].call(D)},I=function(P){var O="transitionFadeSpeed",N=O in r?r[O]:0,M=n.$content;if(N&&!a){t=true;G(M,0,N,function(){P();c(function(){G(M,1,N,function(){t=false})})})}else{P()}},A=function(){var O=D.items.length,N=n.$previous,M=n.$next;if(O<2){D.disableElement(N);D.disableElement(M)}else{if(!r.cycle){D[(D.index>0?"enable":"disable")+"Element"](N);D[(D.index<O-1?"enable":"disable")+"Element"](M)}}};var g=function(N){if(!N){return null}var M=s.getVideo();return !!(M.canPlayType&&M.canPlayType(N).replace(/no/,""))},h={video:{mp4:'video/mp4; codecs="avc1.42E01E, mp4a.40.2"',webm:'video/webm; codecs="vp8, vorbis"',ogg:'video/ogg; codecs="theora, vorbis"'},audio:{}};k(s,{Media:u,guessMediaType:j,formats:h,testVideoFormat:g});var n=s.dom={};k(s,{DEBUG:false,opened:false,instance:null,init:function(){if(s.initialized){return}var M=y('<div id="fuzzbox"><div id="fzz-overlay"></div><div id="fzz-outer"><div id="fzz-wrapper" tabindex="0"><div id="fzz-inner"></div><div id="fzz-loading"></div><a id="fzz-close" href="modal:close"><span></span></a></div></div></div>');k(n,{$fuzzbox:M,$overlay:y("#fzz-overlay",M),$loading:y("#fzz-loading",M),$outer:y("#fzz-outer",M),$wrapper:y("#fzz-wrapper",M),$inner:y("#fzz-inner",M),$closeBtn:y("#fzz-close",M)});n.$loading.hide();var P=n.$wrapper;P.click(function(W){var R=y(W.target).closest("a"),V=R[0],X=null;var U="modal:",T;if(V&&V.href&&V.href.indexOf(U)==0){X=V.href.substring(U.length);var S;if((S=X.indexOf("("))!==-1){T=X.substring(S).replace(/[\(\)]/g,"");X=X.substring(0,S)}}if(!X){return}if(R.hasClass("disabled")){return false}switch(X){case"close":s.close();break;case"previous":s.previous();break;case"next":s.next();break;case"goto":s.goTo(T||1);break}return false});var Q,N=function(X,ad){var U=X.pageX,S=X.pageY,ac=ad.width(),T=ad.offset(),R=T.left,Z=T.top,W=parseInt(ad.css("left"),10)||0,V=parseInt(ad.css("top"),10)||0,ab=U-R,aa=S-Z,Y=w.width();Q={el:{T:Z,R:R+ac,L:R,sX:W,sY:V,bT:-(Z-V),bL:-(R-W),bR:-(R-W)+(Y-ac)},m:{sX:U,sY:S,bT:aa,bR:Y-(ac-ab),bL:ab}};L.mousemove(O)},O=function(X){var W=X.pageX,V=X.pageY,Y=Q.m,T=Q.el,R=P[0],S=R.style,U,Z;if(V<Y.bT){Z=T.bT}else{Z=T.sY+(V-Y.sY)}if(W<Y.bL){U=T.bL}else{if(W>Y.bR){U=T.bR}else{U=T.sX+(W-Y.sX)}}S.top=Z+"px";S.left=U+"px"};P.mousedown(function(S){var R=y(S.target);if(R.hasClass("fzz-handle")){N(S,P);L.one("mouseup blur",function(){L.unbind("mousemove",O)});return false}});y([n.$overlay[0],n.$outer[0]]).click(function(R){if(R.target===this&&r.closeOnClickOutside){s.close()}});L.keyup(function(S){var R=S.keyCode||S.which;if(R===27&&s.opened&&r.closeOnPressEscape){s.close()}});L.keydown(function(S){var R=S.keyCode||S.which;if(s.opened){if(37===R){s.previous();S.preventDefault()}else{if(39===R){s.next();S.preventDefault()}}}});w.resize(function(){s.position();s.positionHero()});n.$fuzzbox.hide();y("body").append(s.dom.$fuzzbox);q("init");s.initialized=true},_open:function(){var M=n.$fuzzbox;M.show();s.position();s.opened=true},_close:function(N){var M=n.$fuzzbox;G(M,0,J.fadeSpeed,function(){M.hide().css("opacity","");N&&N()});s.opened=false},open:function(M){return !(new s(M).open())},close:function(){D&&D.close()},previous:function(){D&&D.previous()},next:function(){D&&D.next()},goTo:function(M){D&&D.goTo(M)},position:function(){var N=n.$outer[0],O=N.offsetHeight,M=w.height(),Q=w.scrollTop(),P=0,R=r.vAlign;if("middle"===R){if(M>O){P=(M-O)/2}}else{if("top"===R){}else{if(+R){P=R}}}P+=Q;N.style.top=P+"px"},positionHero:function(){var M=n.$content.find(".fzz-hero");if(M.length){var N=M[0],O=n.$content[0].offsetHeight-N.offsetHeight;if(O>0){N.style.marginTop=(O/2)+"px"}}},loadUrl:function(M,N,O){y.ajax({url:M,success:function(P){N.html=P;O(N)},error:function(Q,P){N.errorMsg=P;O(N)}})},loadImage:function(N,O,P){var M=new Image;M.onload=function(){O.image=M;P(O)};M.onabort=M.onerror=function(Q){Q=Q||window.event;O.errorMsg=Q.type+' loading image: "'+N+'"';P(O)};M.src=N},getIframe:function(N){var M=n.iframe;if(false===N){M&&(M.src="");return}if(!M){M=n.iframe=x("iframe")}y(M).attr({"class":"fzz-hero",frameborder:0,width:"100%",height:"100%"});return M},getVideo:function(){var M=n.video;if(!M){M=n.video=x("video");M.className="fzz-hero"}return M},getAudio:function(){var M=n.audio;if(!M){M=n.audio=x("audio");M.className="fzz-hero"}return M},getImage:function(M){var N=n.image;if(false===M){N&&(N.src="");return}if(!N){N=n.image=x("img");N.className="fzz-hero"}return N},setDims:function(Q,M,O){var P,N;if(!arguments.length){N={"max-width":D.dims.width||""};P={"min-height":D.dims.height||"","max-height":""}}else{N={"max-width":Q||"",};P={"min-height":D.dims.height||"","max-height":""};P[(O?"max":"min")+"-height"]=M||""}n.$content.css(P);n.$wrapper.css(N)},markdown:function(M){return y.trim((" "+M+" ").replace(/([^_\w])_([^_]+)_([^_\w])/g,function(Q,P,O,N){return P+"<i>"+O+"</i>"+N}).replace(/([^\*\w])\*([^\*]+)\*([^\*\w])/g,function(Q,P,O,N){return P+"<b>"+O+"</b>"+N}))},template:{basic:y('<div id="fzz-handle" class="fzz-handle"></div><div id="fzz-content"></div><div id="fzz-caption"></div><a id="fzz-previous" href="modal:previous"><span></span></a><a id="fzz-next" href="modal:next"><span></span></a>')},media:{error:{insert:function(O,M,N){M.innerHTML='<p class="fzz-hero">'+O.errorMsg+"</p>"}},html:{load:function(O,M,N){if(!C(O.html)&&O.url){s.loadUrl(O.url,O,function(P){M(P.errorMsg)})}else{M()}},insert:function(P,M,O){if(O.target){var N=x("div");N.innerHTML=P.html;P.html=y(N).find(O.target).html()}M.innerHTML=P.html}},image:{load:function(O,M,N){s.loadImage(O.url,O,function(P){M(P.errorMsg)})},insert:function(O,M,N){var P=s.getImage();if(!P.parentNode){M.appendChild(P)}P.src=O.image.src;if(r.exactFit){s.setDims(P.width,P.height,true)}}},iframe:{insert:function(S,N,O){var Q=s.getIframe(),P=("width" in O)?O.width:"100%",M=("height" in O)?O.height:"100%",R={src:S.url||O.url,width:P,height:M};delete O.url;delete O.src;y.extend(R,O);y(Q).attr(R);N.appendChild(Q)}},"video/youtube":{insert:function(R,N,O){var Q=s.getIframe(),P=("width" in O)?O.width:"100%",M=("height" in O)?O.height:"100%";y(Q).attr({src:"http://www.youtube.com/embed/"+O.ytid,width:P,height:M});N.appendChild(Q)}}}});var J=s.settings={};k(J,{text:{close:"Close",next:"Next",previous:"Previous"},preloadDelay:80,fadeSpeed:120,});y.fn.fuzzbox=function(O){var Q=this,O=O||{},P="html" in O,N=O.url,R=(true===O.group)&&!(P||N),M=[];if(R){Q.each(function(){var S={};S.url=this.href;S.element=this;M.push(S)})}Q.click(function(){var U=new y.fuzzbox,V=0,T=this,S=k({},O);S.element=this;if(P||N){}else{if(R){F(M,function(W,X){if(T===X.element){V=W}});S.index=V}else{if(O.items){M=O.items}else{M=[{url:this.href,element:this}]}}}if(M.length){S.items=M}return !U.open(S)});return Q}})(jQuery);