/*!
 *
 * fuzzbox.js
 *
 * Flexible media lightbox for jQuery
 *
 * Project page: https://github.com/peteboere/fuzzbox
 * License: http://www.opensource.org/licenses/mit-license.php
 * Copyright: (c) 2012 Pete Boere
 *
 */
(function(k){var j=window,H=document,u=k(j),o=k(H),D=k.extend,i=k.each,n=function(I){if(w.DEBUG){j.console.log("fuzzbox: "+I)}},c=function(I){return typeof I!=="undefined"},r=function(I){return I.charAt(0).toUpperCase()+I.substring(1)},l=function(P,L,K,N,O,I){var J=k.fn.transition?"transition":"animate";var M={};M[L]=K;P[J](M,N,O,I)},m=function(L,J,K,I){l(L,"opacity",J,K,"linear",I)},B=function(M,J,L){var I=M;if(J.indexOf("*")===-1){I.removeClass(J);return !L?I:I.addClass(L)}var K=new RegExp("\\s"+J.replace(/\*/g,"[A-Za-z0-9-_]+").split(" ").join("\\s|\\s")+"\\s","g");I.each(function(N,O){var P=" "+O.className+" ";while(K.test(P)){P=P.replace(K," ")}O.className=k.trim(P)});return !L?I:I.addClass(L)},g=function(J,I){return setTimeout(J,I||0)},v=function(I){return H.createElement(I)},q=function(){};j.console=j.console||{log:q,error:q};Object.keys=Object.keys||function(K){var J=[],I;for(I in K){if(K.hasOwnProperty(I)){J.push(I)}}return J};var w=k.fuzzbox=function(I){var I=this.options=D({vAlign:"middle",transitionFadeSpeed:100,theme:"default",template:"basic",text:C.text,cycle:false,exactFit:false,closeOnClickOutside:true,closeOnPressEscape:true},I||{})};w.prototype={options:{},items:[],previousItem:null,activeItem:null,index:null,dims:null,trigger:null,$template:null,open:function(U){var W=this;W.options=h=D(W.options,U||{});w.init();W.$template=w.template[h.template||"basic"];var V=b.$inner;V.append(W.$template);b.$content=V.find("#fzz-content");b.$caption=V.find("#fzz-caption");b.$previous=V.find("#fzz-previous");b.$next=V.find("#fzz-next");b.$closeBtn.find(">span").html(h.text.close);b.$previous.find(">span").html(h.text.previous);b.$next.find(">span").html(h.text.next);var R=h.items||[],N="html" in h;if(N||h.url){var P={caption:h.caption,mediaArgs:h.mediaArgs,element:h.element,width:h.width,height:h.height};if(N){P.html=h.html}else{P.url=h.url}R=[P]}R=k.grep(R,function(ab,X){var Y=("html" in ab)||(ab.url&&ab.url!=location.href);if(!Y){return false}var aa=ab.element,Z=z(aa),ac;if("html" in ab){ac="html"}else{if(ab.media){ac=ab.media}else{if(Z&&Z.media){ac=Z.media}else{if(!(ac=d(ab.url))){ac="html"}}}}ab.media=new t(ac);ab.attr=Z||{};if("html"===ab.media[0]&&!c(ab.html)&&ab.attr.html){ab.html=unescape(ab.attr.html)}if(Z){if(Z.mediaArgs){ab.mediaArgs=D({},Z.mediaArgs,ab.mediaArgs)}}return !!ac});var I=R.length,Q=I===1;if(!I){n("No items to display");return false}i(R,function(X,Y){Y.index=X;Y.group=R});W.items=R;W.index=h.index||0;if(W.index>I-1){W.index=I-1}p=W.items[W.index];E=w.instance=this;var O=(Q&&p.attr.theme)||h.theme||"default",M=["fzz-startup","fzz-itemcount-"+W.items.length,"fzz-theme-"+k.trim(O).split(" ").join(" fzz-theme-")];b.$fuzzbox.attr("class",M.join(" "));var J="width" in h?h.width:"",T="height" in h?h.height:"",Q=I===1,L=p.attr.width,K=p.attr.height,S=/[^0-9\.]/;if(!J&&Q&&L){J=S.test(L)?L:+L}if(!T&&Q&&p.attr.height){T=S.test(K)?K:+K}W.dims={width:J,height:T};w.setDims();s();w._open();f("open");W.trigger=H.activeElement;b.$wrapper.focus();F=true;W.loadItem(p,function(){B(b.$fuzzbox,"fzz-startup","fzz-open");F=false});return true},loadItem:function(Q,O){var R=this,I=b.$content[0],K=b.$caption[0];R.previousItem=A=R.activeItem;R.activeItem=p=Q;R.prepareLoadMsg();var M=null,L;if("errorMsg" in Q){M="error"}else{var S=Q.media.toString(),J=Q.media[0];if(w.media[S]){M=S}else{if(w.media[J]){M=J}else{M="html"}}}var P=w.media[M],N=function(W,U){R.clearContentAreas();B(b.$fuzzbox,"fzz-media-*",y(W.media).join(" "));P.insert(W,I,W.mediaArgs||h.mediaArgs||{});var T=W.caption||R.options.caption,V=W.element;if("function"===typeof T){T=T.call(V||{},W)}K.innerHTML=T||(V&&V.title)||"";f("insert");O&&O();w.positionHero();w.position()};if(!P.load){R.cancelLoadMsg();f("load");e(function(){N(Q,M)})}else{P.load(Q,function(){R.cancelLoadMsg();f("load");if(Q.errorMsg){M="error";P=w.media[M];Q.media.update(M)}e(function(){N(Q,M)})})}},prepareLoadMsg:function(){var I=this;I.loadTimer=setTimeout(function(){I.showLoadMsg()},C.preloadDelay)},cancelLoadMsg:function(){var I=this;I.hideLoadMsg();clearTimeout(I.loadTimer)},showLoadMsg:function(){G=true;b.$loading.show();b.$fuzzbox.addClass("fzz-loading");f("showLoadMsg")},hideLoadMsg:function(){G=false;b.$loading.hide();b.$fuzzbox.removeClass("fzz-loading");f("hideLoadMsg")},disableElement:function(I){I.addClass("disabled").attr("tabindex",-1).blur()},enableElement:function(I){I.removeClass("disabled").removeAttr("tabindex")},goTo:function(L){var K=this,J=K.items,O=J.length-1,I=K.index;if(G||J.length<2){return}var N=h.cycle,M;if("previous"==L){M=(I>0)?I-1:0;if(N){M=I===0?O:I-1}}else{if("next"==L){M=(I<O)?I+1:O;if(N){M=I===O?0:I+1}}else{if(L>0){L-=1;M=L<=O?L:O}else{n("No destination");return}}}K.index=M;s(K);K.loadItem(J[K.index])},next:function(){var I=this;if(!h.cycle&&I.index>=I.items.length-1){return}this.goTo("next")},previous:function(){var I=this;if(!h.cycle&&I.index<=0){return}I.goTo("previous")},close:function(){var I=this;w._close(function(){f("close");if(p.element){p.element.focus()}else{I.trigger&&I.trigger.focus()}I.cleanup()})},cleanup:function(){var I=this;I.clearContentAreas(true);I.enableElement(b.$previous);I.enableElement(b.$next);I.cancelLoadMsg();b.$fuzzbox.removeClass("fzz-open");var J=b.$wrapper[0].style;J.top=J.left="";w.instance=E=null},clearContentAreas:function(J){var I=A&&!A.errorMsg&&"image"===A.media[0]&&"image"===p.media[0];if(!I){b.$content.empty()}b.$caption.empty();w.getIframe(false);var K=w.getImage();K.src=K.style.marginTop="";b.$content.find(".fzz-hero").css("margin-top","");if(J){b.$inner.empty()}}};var E,p,A,F,h,G,t=function(J){var I=this;I.update=function(L){if(typeof L!=="string"){return L}var K=L.indexOf("/");I[0]=L;I[1]=null;if(K!==-1){I[0]=L.substring(0,K);I[1]=L.substring(K+1)}};I.toString=function(){return I[0]+(I[1]?"/"+I[1]:"")};return I.update(J)},d=function(L){var J=L.toLowerCase(),O=J.indexOf("#"),N=null;if(O!==-1){J=J.substring(0,O)}O=J.indexOf("?");if(O!==-1){J=J.substring(0,O)}var K,I=/\.([a-z0-9]+)$/.exec(J.replace(/\/+$/,"").toLowerCase());if(I){K=I[1]}else{return N}if(I=/^(jpe?g|png|gif|tiff?|webp)$/.exec(K)){N="image/"+I[1]}else{if(/^svgz?$/.test(K)){N="image/svg"}else{if(/^(webm|ogv|ogg|ogv|mp4|m4v|3gp)?$/.test(K)){var M="mp4";if(/^(ogv|ogg|ogm)$/.test(K)){M="ogg"}else{if("webm"===K){M="webm"}}N="video/"+M}else{if(I=/^(mp3)?$/.exec(K)){N="audio/"+I[1]}else{if(/^html?$/.test(K)){N="html"}}}}}return N},z=function(J){if(!J){return null}var I={},K="data-fzz-";i(J.attributes,function(O,L){var N=L.name,R=N.indexOf(K);if(0===R){N=N.substring(K.length);var P=N.split("-"),Q=P.shift();if(!I[Q]&&!P.length){I[Q]=L.value}else{if(P.length){var M=Q+"Args";I[M]=I[M]||{};I[M][P[0]]=L.value}}}});return I},y=function(I){var J=[];J.push("fzz-media-"+I[0]);J.push("fzz-media-"+(I+"").replace(/\//,"-"));return J},f=function(I){var J="on"+r(I);o.trigger("fzz_"+I);E&&E[J]&&E[J].call(E)},e=function(L){var K="transitionFadeSpeed",J=K in h?h[K]:0,I=b.$content;if(J&&!F){G=true;m(I,0,J,function(){L();g(function(){m(I,1,J,function(){G=false})},13)})}else{L()}},s=function(){var K=E.items.length,J=b.$previous,I=b.$next;if(K<2){E.disableElement(J);E.disableElement(I)}else{if(!h.cycle){E[(E.index>0?"enable":"disable")+"Element"](J);E[(E.index<K-1?"enable":"disable")+"Element"](I)}}};var a=function(J){if(!J){return null}var I=w.getVideo();return !!(I.canPlayType&&I.canPlayType(J).replace(/no/,""))},x={video:{mp4:'video/mp4; codecs="avc1.42E01E, mp4a.40.2"',webm:'video/webm; codecs="vp8, vorbis"',ogg:'video/ogg; codecs="theora, vorbis"'},audio:{}};D(w,{Media:t,guessMediaType:d,formats:x,testVideoFormat:a});var b=w.dom={};D(w,{DEBUG:false,opened:false,instance:null,init:function(){if(w.initialized){return}var I=k('<div id="fuzzbox"><div id="fzz-overlay"></div><div id="fzz-outer"><div id="fzz-wrapper" tabindex="0"><div id="fzz-inner"></div><div id="fzz-loading"></div><a id="fzz-close" href="modal:close"><span></span></a></div></div></div>');D(b,{$fuzzbox:I,$overlay:k("#fzz-overlay",I),$loading:k("#fzz-loading",I),$outer:k("#fzz-outer",I),$wrapper:k("#fzz-wrapper",I),$inner:k("#fzz-inner",I),$closeBtn:k("#fzz-close",I)});b.$loading.hide();var L=b.$wrapper;L.click(function(S){var N=k(S.target).closest("a"),R=N[0],T=null;var Q="modal:",P;if(R&&R.href&&R.href.indexOf(Q)==0){T=R.href.substring(Q.length);var O;if((O=T.indexOf("("))!==-1){P=T.substring(O).replace(/[\(\)]/g,"");T=T.substring(0,O)}else{if(/^\d$/.test(T)){P=T;T="goto"}}}if(!T){return}if(N.hasClass("disabled")){return false}switch(T){case"close":w.close();break;case"previous":w.previous();break;case"next":w.next();break;case"goto":w.goTo(P||1);break}return false});var M,J=function(T,Z){var Q=T.pageX,O=T.pageY,Y=Z.width(),P=Z.offset(),N=P.left,V=P.top,S=parseInt(Z.css("left"),10)||0,R=parseInt(Z.css("top"),10)||0,X=Q-N,W=O-V,U=u.width();M={el:{T:V,R:N+Y,L:N,sX:S,sY:R,bT:-(V-R),bL:-(N-S),bR:-(N-S)+(U-Y)},m:{sX:Q,sY:O,bT:W,bR:U-(Y-X),bL:X}};o.mousemove(K)},K=function(T){var S=T.pageX,R=T.pageY,U=M.m,P=M.el,N=L[0],O=N.style,Q,V;if(R<U.bT){V=P.bT}else{V=P.sY+(R-U.sY)}if(S<U.bL){Q=P.bL}else{if(S>U.bR){Q=P.bR}else{Q=P.sX+(S-U.sX)}}O.top=V+"px";O.left=Q+"px"};L.mousedown(function(O){var N=k(O.target);if(N.hasClass("fzz-handle")){J(O,L);o.one("mouseup blur",function(){o.unbind("mousemove",K)});return false}});k([b.$overlay[0],b.$outer[0]]).click(function(N){if(N.target===this&&h.closeOnClickOutside){w.close()}});o.keyup(function(O){var N=O.keyCode||O.which;if(N===27&&w.opened&&h.closeOnPressEscape){w.close()}});o.keydown(function(O){var N=O.keyCode||O.which;if(w.opened){if(37===N){w.previous();O.preventDefault()}else{if(39===N){w.next();O.preventDefault()}}}});u.resize(function(){w.position();w.positionHero()});b.$fuzzbox.hide();k("body").append(w.dom.$fuzzbox);f("init");w.initialized=true},_open:function(){var I=b.$fuzzbox;I.show();w.position();w.opened=true},_close:function(J){var I=b.$fuzzbox;m(I,0,C.fadeSpeed,function(){I.hide().css("opacity","");J&&J()});w.opened=false},open:function(I){return !(new w(I).open())},close:function(){E&&E.close()},previous:function(){E&&E.previous()},next:function(){E&&E.next()},goTo:function(I){E&&E.goTo(I)},position:function(){var J=b.$outer[0],K=J.offsetHeight,I=u.height(),M=u.scrollTop(),L=0,N=h.vAlign;if("middle"===N){if(I>K){L=(I-K)/2}}else{if("top"===N){}else{if(+N){L=N}}}L+=M;J.style.top=L+"px"},positionHero:function(){var I=b.$content.find(".fzz-hero");if(I.length){var J=I[0],K=b.$content[0].offsetHeight-J.offsetHeight;if(K>0){J.style.marginTop=(K/2)+"px"}}},loadUrl:function(I,J,K){k.ajax({url:I,success:function(L){J.html=L;K(J)},error:function(M,L){J.errorMsg=L;K(J)}})},loadImage:function(J,K,L){var I=new Image;I.onload=function(){K.image=I;L(K)};I.onabort=I.onerror=function(M){M=M||window.event;K.errorMsg=M.type+' loading image: "'+J+'"';L(K)};I.src=J},getIframe:function(J){var I=b.iframe;if(false===J){I&&(I.src="");return}if(!I){I=b.iframe=v("iframe")}k(I).attr({"class":"fzz-hero",frameborder:0,width:"100%",height:"100%"});return I},getVideo:function(){var I=b.video;if(!I){I=b.video=v("video");I.className="fzz-hero"}return I},getAudio:function(){var I=b.audio;if(!I){I=b.audio=v("audio");I.className="fzz-hero"}return I},getImage:function(I){var J=b.image;if(!J){J=b.image=v("img");J.className="fzz-hero"}return J},setDims:function(M,I,K){var L,J;if(!arguments.length){J={"max-width":E.dims.width||""};L={"min-height":E.dims.height||"","max-height":""}}else{J={"max-width":M||""};L={"min-height":E.dims.height||"","max-height":""};L[(K?"max":"min")+"-height"]=I||""}b.$content.css(L);b.$wrapper.css(J)},markdown:function(I){return k.trim((" "+I+" ").replace(/([^_\w])_([^_]+)_([^_\w])/g,function(M,L,K,J){return L+"<i>"+K+"</i>"+J}).replace(/([^\*\w])\*([^\*]+)\*([^\*\w])/g,function(M,L,K,J){return L+"<b>"+K+"</b>"+J}))},template:{basic:k('<div id="fzz-handle" class="fzz-handle"></div><div id="fzz-content"></div><div id="fzz-caption"></div><a id="fzz-previous" href="modal:previous"><span></span></a><a id="fzz-next" href="modal:next"><span></span></a>')},media:{error:{insert:function(K,I,J){I.innerHTML='<p class="fzz-hero">'+K.errorMsg+"</p>"}},html:{load:function(K,I,J){if(!c(K.html)&&K.url){w.loadUrl(K.url,K,function(L){I(L.errorMsg)})}else{I()}},insert:function(L,I,K){if(K.target){var J=v("div");J.innerHTML=L.html;L.html=k(J).find(K.target).html()}I.innerHTML=L.html}},image:{load:function(K,I,J){w.loadImage(K.url,K,function(L){I(L.errorMsg)})},insert:function(K,I,J){var L=w.getImage();if(!L.parentNode){I.appendChild(L)}L.src=K.image.src;if(h.exactFit){w.setDims(L.width,L.height,true)}}},iframe:{insert:function(O,J,K){var M=w.getIframe(),L=("width" in K)?K.width:"100%",I=("height" in K)?K.height:"100%",N={src:O.url||K.url,width:L,height:I};delete K.url;delete K.src;k.extend(N,K);k(M).attr(N);J.appendChild(M)}},"video/youtube":{insert:function(N,J,K){var M=w.getIframe(),L=("width" in K)?K.width:"100%",I=("height" in K)?K.height:"100%";k(M).attr({src:"http://www.youtube.com/embed/"+K.ytid,width:L,height:I});J.appendChild(M)}}}});var C=w.settings={};D(C,{text:{close:"Close",next:"Next",previous:"Previous"},preloadDelay:80,fadeSpeed:120});k.fn.fuzzbox=function(K){var M=this,K=K||{},L="html" in K,J=K.url,N=(true===K.group)&&!(L||J),I=[];if(N){M.each(function(){var O={};O.url=this.href;O.element=this;I.push(O)})}M.click(function(){var Q=new k.fuzzbox,R=0,P=this,O=D({},K);O.element=this;if(L||J){}else{if(N){i(I,function(S,T){if(P===T.element){R=S}});O.index=R}else{if(K.items){I=K.items}else{I=[{url:this.href,element:this}]}}}if(I.length){O.items=I}return !Q.open(O)});return M}})(jQuery);