/*!

Flexible media lightbox for jQuery

Project page: https://github.com/peteboere/fuzzbox
License: http://www.opensource.org/licenses/mit-license.php
Copyright: (c) 2012 Pete Boere

*/(function(a){var b=window,c=document,d=a(b),e=a(c),f=a.extend,g=a.each,h=function(a){r.DEBUG&&b.console.log("fuzzbox: "+a)},i=function(a){return typeof a!="undefined"},j=function(a){return a.charAt(0).toUpperCase()+a.substring(1)},k=function(b,c,d,e,f,g){var h=a.fn.transition?"transition":"animate",i={};i[c]=d,b[h](i,e,f,g)},l=function(a,b,c,d){k(a,"opacity",b,c,"linear",d)},m=function(b,c,d){var e=b;if(c.indexOf("*")===-1)return e.removeClass(c),d?e.addClass(d):e;var f=new RegExp("\\s"+c.replace(/\*/g,"[A-Za-z0-9-_]+").split(" ").join("\\s|\\s")+"\\s","g");return e.each(function(b,c){var d=" "+c.className+" ";while(f.test(d))d=d.replace(f," ");c.className=a.trim(d)}),d?e.addClass(d):e},n=function(a,b){return setTimeout(a,b||0)},o=function(a){return c.createElement(a)},p=function(){},q=!!b.ActiveXObject&&+/msie\s(\d+)/i.exec(navigator.userAgent)[1]||NaN;b.console=b.console||{log:p,error:p},Object.keys=Object.keys||function(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(c);return b};var r=a.fuzzbox=function(a){var a=this.options=f({vAlign:"middle",transitionFadeSpeed:100,theme:"default",template:"basic",text:I.text,cycle:!1,exactFit:!1,closeOnClickOutside:!0,closeOnPressEscape:!0},a||{})};r.prototype={options:{},items:[],previousItem:null,activeItem:null,index:null,dims:null,trigger:null,$template:null,open:function(b){var d=this;d.options=w=f(d.options,b||{}),r.init(),d.$template=r.template[w.template||"basic"];var e=H.$inner;e.append(d.$template),H.$content=e.find("#fzz-content"),H.$caption=e.find("#fzz-caption"),H.$previous=e.find("#fzz-previous"),H.$next=e.find("#fzz-next"),H.$closeBtn.find(">span").html(w.text.close),H.$previous.find(">span").html(w.text.previous),H.$next.find(">span").html(w.text.next);var j=w.items||[],k="html"in w;if(k||w.url){var l={caption:w.caption,mediaArgs:w.mediaArgs,element:w.element,width:w.width,height:w.height};k?l.html=w.html:l.url=w.url,j=[l]}j=a.grep(j,function(a,b){var c="html"in a||a.url&&a.url!=location.href;if(!c)return!1;var d=a.element,e=A(d),g;return"html"in a?g="html":a.media?g=a.media:e&&e.media?g=e.media:(g=z(a.url))||(g="html"),a.media=new y(g),a.attr=e||{},"html"===a.media[0]&&!i(a.html)&&a.attr.html&&(a.html=unescape(a.attr.html)),e&&e.mediaArgs&&(a.mediaArgs=f({},e.mediaArgs,a.mediaArgs)),!!g});var n=j.length,o=n===1;if(!n)return h("No items to display"),!1;g(j,function(a,b){b.index=a,b.group=j}),d.items=j,d.index=w.index||0,d.index>n-1&&(d.index=n-1),t=d.items[d.index],s=r.instance=this;var p=o&&t.attr.theme||w.theme||"default",q=["fzz-startup","fzz-itemcount-"+d.items.length,"fzz-theme-"+a.trim(p).split(" ").join(" fzz-theme-")];H.$fuzzbox.attr("class",q.join(" "));var u="width"in w?w.width:"",x="height"in w?w.height:"",o=n===1,B=t.attr.width,D=t.attr.height,F=/[^0-9\.]/;return!u&&o&&B&&(u=F.test(B)?B:+B),!x&&o&&t.attr.height&&(x=F.test(D)?D:+D),d.dims={width:u,height:x},r.setDims(),E(),r._open(),C("open"),d.trigger=c.activeElement,H.$wrapper.focus(),v=!0,d.loadItem(t,function(){m(H.$fuzzbox,"fzz-startup","fzz-open"),v=!1}),!0},loadItem:function(a,b){var c=this,d=H.$content[0],e=H.$caption[0];c.previousItem=u=c.activeItem,c.activeItem=t=a,c.prepareLoadMsg();var f=null,g;if("errorMsg"in a)f="error";else{var h=a.media.toString(),i=a.media[0];r.media[h]?f=h:r.media[i]?f=i:f="html"}var j=r.media[f],k=function(a,f){c.clearContentAreas(),m(H.$fuzzbox,"fzz-media-*",B(a.media).join(" ")),j.insert(a,d,a.mediaArgs||w.mediaArgs||{});var g=a.caption||c.options.caption,h=a.element;"function"==typeof g&&(g=g.call(h||{},a)),e.innerHTML=g||h&&h.title||"",C("insert"),b&&b(),r.positionHero(a),r.position()};j.load?j.load(a,function(){c.cancelLoadMsg(),C("load"),a.errorMsg&&(f="error",j=r.media[f],a.media.update(f)),D(function(){k(a,f)})}):(c.cancelLoadMsg(),C("load"),D(function(){k(a,f)}))},prepareLoadMsg:function(){var a=this;a.loadTimer=setTimeout(function(){a.showLoadMsg()},I.preloadDelay)},cancelLoadMsg:function(){var a=this;a.hideLoadMsg(),clearTimeout(a.loadTimer)},showLoadMsg:function(){x=!0,H.$loading.show(),H.$fuzzbox.addClass("fzz-loading"),C("showLoadMsg")},hideLoadMsg:function(){x=!1,H.$loading.hide(),H.$fuzzbox.removeClass("fzz-loading"),C("hideLoadMsg")},disableElement:function(a){a.addClass("disabled").attr("tabindex",-1).blur()},enableElement:function(a){a.removeClass("disabled").removeAttr("tabindex")},goTo:function(a){var b=this,c=b.items,d=c.length-1,e=b.index;if(x||c.length<2)return;var f=w.cycle,g;if("previous"==a)g=e>0?e-1:0,f&&(g=e===0?d:e-1);else if("next"==a)g=e<d?e+1:d,f&&(g=e===d?0:e+1);else{if(!(a>0)){h("No destination");return}a-=1,g=a<=d?a:d}b.index=g,E(b),b.loadItem(c[b.index])},next:function(){var a=this;if(!w.cycle&&a.index>=a.items.length-1)return;this.goTo("next")},previous:function(){var a=this;if(!w.cycle&&a.index<=0)return;a.goTo("previous")},close:function(){var a=this;r._close(function(){C("close"),t.element?t.element.focus():a.trigger&&a.trigger.focus(),a.cleanup()})},cleanup:function(){var a=this;a.clearContentAreas(!0),a.enableElement(H.$previous),a.enableElement(H.$next),a.cancelLoadMsg(),H.$fuzzbox.removeClass("fzz-open");var b=H.$wrapper[0].style;b.top=b.left="",r.instance=s=null},clearContentAreas:function(a){var b=u&&!u.errorMsg&&"image"===u.media[0]&&"image"===t.media[0];b||H.$content.empty(),H.$caption.empty(),r.resetImage(),r.resetIframe(),H.$content.find(".fzz-hero").css("margin-top",""),a&&(H.$inner.empty(),H.$outer.css("top",""),r.resetImage(!0))}};var s,t,u,v,w,x,y=function(a){var b=this;return b.update=function(a){if(typeof a!="string")return a;var c=a.indexOf("/");b[0]=a,b[1]=null,c!==-1&&(b[0]=a.substring(0,c),b[1]=a.substring(c+1))},b.toString=function(){return b[0]+(b[1]?"/"+b[1]:"")},b.update(a)},z=function(a){var b=a.toLowerCase(),c=b.indexOf("#"),d=null;c!==-1&&(b=b.substring(0,c)),c=b.indexOf("?"),c!==-1&&(b=b.substring(0,c));var e,f=/\.([a-z0-9]+)$/.exec(b.replace(/\/+$/,"").toLowerCase());if(!f)return d;e=f[1];if(f=/^(jpe?g|png|gif|tiff?|webp)$/.exec(e))d="image/"+f[1];else if(/^svgz?$/.test(e))d="image/svg";else if(/^(webm|ogv|ogg|ogv|mp4|m4v|3gp)?$/.test(e)){var g="mp4";/^(ogv|ogg|ogm)$/.test(e)?g="ogg":"webm"===e&&(g="webm"),d="video/"+g}else(f=/^(mp3)?$/.exec(e))?d="audio/"+f[1]:/^html?$/.test(e)&&(d="html");return d},A=function(a){if(!a)return null;var b={},c="data-fzz-";return g(a.attributes,function(a,d){var e=d.name,f=e.indexOf(c);if(0===f){e=e.substring(c.length);var g=e.split("-"),h=g.shift();if(!b[h]&&!g.length)b[h]=d.value;else if(g.length){var i=h+"Args";b[i]=b[i]||{},b[i][g[0]]=d.value}}}),b},B=function(a){var b=[];return b.push("fzz-media-"+a[0]),b.push("fzz-media-"+(a+"").replace(/\//,"-")),b},C=function(a){var b="on"+j(a);e.trigger("fzz_"+a),s&&s[b]&&s[b].call(s)},D=function(a){var b="transitionFadeSpeed",c=b in w?w[b]:0,d=H.$content;c&&!v?(x=!0,l(d,0,c,function(){a(),n(function(){l(d,1,c,function(){x=!1})},13)})):a()},E=function(){var a=s.items.length,b=H.$previous,c=H.$next;a<2?(s.disableElement(b),s.disableElement(c)):w.cycle||(s[(s.index>0?"enable":"disable")+"Element"](b),s[(s.index<a-1?"enable":"disable")+"Element"](c))},F=function(a){if(!a)return null;var b=r.getVideo();return!!b.canPlayType&&!!b.canPlayType(a).replace(/no/,"")},G={video:{mp4:'video/mp4; codecs="avc1.42E01E, mp4a.40.2"',webm:'video/webm; codecs="vp8, vorbis"',ogg:'video/ogg; codecs="theora, vorbis"'},audio:{}};f(r,{Media:y,guessMediaType:z,formats:G,testVideoFormat:F});var H=r.dom={};f(r,{DEBUG:!1,opened:!1,instance:null,init:function(){if(r.initialized)return;var b=a('<div id="fuzzbox"><div id="fzz-overlay"></div><div id="fzz-outer"><div id="fzz-wrapper" tabindex="0"><div id="fzz-inner"></div><div id="fzz-loading"></div><a id="fzz-close" href="modal:close"><span></span></a></div></div></div>');f(H,{$fuzzbox:b,$overlay:a("#fzz-overlay",b),$loading:a("#fzz-loading",b),$outer:a("#fzz-outer",b),$wrapper:a("#fzz-wrapper",b),$inner:a("#fzz-inner",b),$closeBtn:a("#fzz-close",b)}),H.$loading.hide();var c=H.$wrapper;c.click(function(b){var c=a(b.target).closest("a"),d=c[0],e=null,f="modal:",g;if(d&&d.href&&d.href.indexOf(f)==0){e=d.href.substring(f.length);var h;(h=e.indexOf("("))!==-1?(g=e.substring(h).replace(/[\(\)]/g,""),e=e.substring(0,h)):/^\d$/.test(e)&&(g=e,e="goto")}if(!e)return;if(c.hasClass("disabled"))return!1;switch(e){case"close":r.close();break;case"previous":r.previous();break;case"next":r.next();break;case"goto":r.goTo(g||1)}return!1});var g,h=function(a,b){var c=a.pageX,f=a.pageY,h=b.width(),j=b.offset(),k=j.left,l=j.top,m=parseInt(b.css("left"),10)||0,n=parseInt(b.css("top"),10)||0,o=c-k,p=f-l,q=d.width();g={el:{T:l,R:k+h,L:k,sX:m,sY:n,bT:-(l-n),bL:-(k-m),bR:-(k-m)+(q-h)},m:{sX:c,sY:f,bT:p,bR:q-(h-o),bL:o}},e.mousemove(i)},i=function(a){var b=a.pageX,d=a.pageY,e=g.m,f=g.el,h=c[0],i=h.style,j,k;d<e.bT?k=f.bT:k=f.sY+(d-e.sY),b<e.bL?j=f.bL:b>e.bR?j=f.bR:j=f.sX+(b-e.sX),i.top=k+"px",i.left=j+"px"};c.mousedown(function(b){var d=a(b.target);if(d.hasClass("fzz-handle"))return h(b,c),e.one("mouseup blur",function(){e.unbind("mousemove",i)}),!1}),a([H.$overlay[0],H.$outer[0]]).click(function(a){a.target===this&&w.closeOnClickOutside&&r.close()}),e.keyup(function(a){var b=a.keyCode||a.which;b===27&&r.opened&&w.closeOnPressEscape&&r.close()}),e.keydown(function(a){var b=a.keyCode||a.which;r.opened&&(37===b?(r.previous(),a.preventDefault()):39===b&&(r.next(),a.preventDefault()))}),d.resize(function(){r.position(),r.positionHero(),r.setHeight()}),H.$fuzzbox.hide(),a("body").append(r.dom.$fuzzbox),C("init"),r.initialized=!0},_open:function(){var a=H.$fuzzbox;a.show(),r.position(),r.opened=!0},_close:function(a){var b=H.$fuzzbox;l(b,0,I.fadeSpeed,function(){b.hide().css("opacity",""),a&&a()}),r.opened=!1},open:function(a){return!(new r(a)).open()},close:function(){s&&s.close()},previous:function(){s&&s.previous()},next:function(){s&&s.next()},goTo:function(a){s&&s.goTo(a)},position:function(){var a=H.$outer[0],b=a.offsetHeight,c=d.height(),e=d.scrollTop(),f=0,g=w.vAlign;"middle"===g?c>b&&(f=(c-b)/2):"top"!==g&&+g&&(f=g),f+=e,a.style.top=f+"px"},positionHero:function(a){var b=H.$content.find(".fzz-hero");if(!w.exactFit&&b.length){var c=b[0],d=H.$content[0].offsetHeight,e=c.offsetHeight;a&&a.image&&(e=a.image.height),diff=d-e,diff>0&&(c.style.marginTop=diff/2+"px")}},loadUrl:function(b,c,d){a.ajax({url:b,success:function(a){c.html=a,d(c)},error:function(a,b){c.errorMsg=b,d(c)}})},loadImage:function(a,b,c){var d=new Image;d.onload=function(){b.image=d,c(b)},d.onabort=d.onerror=function(d){d=d||window.event,b.errorMsg=d.type+' loading image: "'+a+'"',c(b)},d.src=a},getIframe:function(b){var c=H.iframe;return c||(c=H.iframe=o("iframe")),a(c).attr({"class":"fzz-hero",frameborder:0,width:"100%",height:"100%"}),c},resetIframe:function(){var a=H.iframe;a&&(a.src="data:text/html,0")},getVideo:function(){var a=H.video;return a||(a=H.video=o("video"),a.className="fzz-hero"),a},getAudio:function(){var a=H.audio;return a||(a=H.audio=o("audio"),a.className="fzz-hero"),a},getImage:function(){var a=H.image;return a||(a=H.image=o("img"),a.className="fzz-hero"),a},resetImage:function(a){var b=H.image;b&&(a?(delete H.image,H.image=r.getImage()):b.style.marginTop="")},setDims:function(){r.setWidth(),r.setHeight()},setWidth:function(a){widthMap={"max-width":s.dims.width||a||""};if(widthMap["max-width"]&&/\d+(px)?$/.test(widthMap["max-width"]+"")){var b=H.$inner,c=b.outerWidth(!0)-b.width();widthMap["max-width"]=parseInt(widthMap["max-width"],10)+c}H.$wrapper.css(widthMap)},setHeight:function(a){var b={height:s.dims.height||a||""};H.$content.css(b)},markdown:function(b){return a.trim((" "+b+" ").replace(/([^_\w])_([^_]+)_([^_\w])/g,function(a,b,c,d){return b+"<i>"+c+"</i>"+d}).replace(/([^\*\w])\*([^\*]+)\*([^\*\w])/g,function(a,b,c,d){return b+"<b>"+c+"</b>"+d}))},template:{basic:a('<div id="fzz-handle" class="fzz-handle"></div><div id="fzz-content"></div><div id="fzz-caption"></div><a id="fzz-previous" href="modal:previous"><span></span></a><a id="fzz-next" href="modal:next"><span></span></a>')},media:{error:{insert:function(a,b,c){b.innerHTML='<p class="fzz-hero">'+a.errorMsg+"</p>"}},html:{load:function(a,b,c){!i(a.html)&&a.url?r.loadUrl(a.url,a,function(a){b(a.errorMsg)}):b()},insert:function(b,c,d){if(d.target){var e=o("div");e.innerHTML=b.html,b.html=a(e).find(d.target).html()}c.innerHTML=b.html}},image:{load:function(a,b,c){r.loadImage(a.url,a,function(a){b(a.errorMsg)})},insert:function(a,b,c){var d=r.getImage();d.parentNode||b.appendChild(d),d.src=a.image.src,r.setHeight(a.image.height),w.exactFit&&r.setWidth(a.image.width)}},iframe:{insert:function(b,c,d){var e=r.getIframe(),f="width"in d?d.width:"100%",g="height"in d?d.height:"100%",h={src:b.url||d.url,width:f,height:g};delete d.url,delete d.src,a.extend(h,d),a(e).attr(h),c.appendChild(e)}},"video/youtube":{insert:function(b,c,d){var e=r.getIframe(),f="width"in d?d.width:"100%",g="height"in d?d.height:"100%";a(e).attr({src:"http://www.youtube.com/embed/"+d.ytid,width:f,height:g}),c.appendChild(e)}}}});var I=r.settings={};f(I,{text:{close:"Close",next:"Next",previous:"Previous"},preloadDelay:80,fadeSpeed:150}),a.fn.fuzzbox=function(b){var c=this,b=b||{},d="html"in b,e=b.url,h=!0===b.group&&!d&&!e,i=[];return h&&c.each(function(){var a={};a.url=this.href,a.element=this,i.push(a)}),c.click(function(){var c=new a.fuzzbox,j=0,k=this,l=f({},b);return l.element=this,!d&&!e&&(h?(g(i,function(a,b){k===b.element&&(j=a)}),l.index=j):b.items?i=b.items:i=[{url:this.href,element:this}]),i.length&&(l.items=i),!c.open(l)}),c}})(jQuery);